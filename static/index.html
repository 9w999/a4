<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>地域お手伝いマップ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #f4f6f8;
}

header {
    padding: 12px;
    font-weight: bold;
    text-align: center;
    background: #4caf50;
    color: #fff;
}

#map {
    height: 55vh;
}

.card {
    background: #fff;
    margin: 12px;
    padding: 16px;
    border-radius: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

label {
    display: block;
    font-size: 14px;
    margin-top: 10px;
}

select, input {
    width: 100%;
    height: 40px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    padding: 4px 8px;
}

button {
    width: 100%;
    margin-top: 16px;
    height: 44px;
    font-size: 17px;
    font-weight: bold;
    border-radius: 10px;
    border: none;
    color: #fff;
    cursor: pointer;
}

.btn-post { background: #4caf50; }
.btn-approve { background: #ff9800; }
.btn-complete { background: #2196f3; }

.leaflet-popup-content {
    font-size: 14px;
}
</style>
</head>

<body>

<header>地域お手伝いマップ</header>
<div id="map"></div>

<div class="card">
    <label>年齢</label>
    <select id="age">
        <option value="">選択してください</option>
        <option>10代</option><option>20代</option><option>30代</option>
        <option>40代</option><option>50代</option><option>60代</option>
        <option>70代</option><option>80代</option><option>90代</option>
    </select>

    <label>性別</label>
    <select id="gender">
        <option value="">選択してください</option>
        <option>男性</option><option>女性</option><option>その他</option>
    </select>

    <label>依頼内容</label>
    <input id="naiyo" placeholder="例：荷物を運んでほしい">

    <button class="btn-post" onclick="post()">募集する</button>
</div>

<script>
let map;

const red = new L.Icon({ iconUrl:'https://maps.google.com/mapfiles/ms/icons/red-dot.png', iconSize:[32,32] });
const green = new L.Icon({ iconUrl:'https://maps.google.com/mapfiles/ms/icons/green-dot.png', iconSize:[32,32] });

navigator.geolocation.getCurrentPosition(p => {
    map = L.map("map").setView([p.coords.latitude, p.coords.longitude], 16);
    init();
}, () => {
    map = L.map("map").setView([35.7,139.49], 15);
    init();
});

function init(){
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    load();
}

function post(){
    navigator.geolocation.getCurrentPosition(p=>{
        fetch("/add",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                lat:p.coords.latitude,
                lng:p.coords.longitude,
                age:age.value,
                gender:gender.value,
                naiyo:naiyo.value
            })
        }).then(()=>load());
    });
}

function load(){
    fetch("/list").then(r=>r.json()).then(data=>{
        map.eachLayer(l=>{ if(l instanceof L.Marker) map.removeLayer(l); });

        data.forEach((d,i)=>{
            const icon = d.approved ? green : red;
            const btn = d.approved
                ? `<button class="btn-complete" onclick="finish(${i})">完了</button>`
                : `<button class="btn-approve" onclick="approve(${i})">承認</button>`;

            L.marker([d.lat,d.lng],{icon}).addTo(map)
            .bindPopup(`
                <b>${d.age} / ${d.gender}</b><br>
                ${d.naiyo}<br>${btn}
            `);
        });
    });
}

function approve(i){
    fetch("/approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:i})})
    .then(()=>load());
}

function finish(i){
    if(confirm("募集を完了しますか？")){
        fetch("/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:i})})
        .then(()=>load());
    }
}
</script>

</body>
</html>
