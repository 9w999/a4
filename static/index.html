<!DOCTYPE HTML>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>高齢者トラブル解決アプリケーション</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      --bg: #f5f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #2563eb; /* blue */
      --accent-2: #10b981; /* green */
      --danger: #ef4444; /* red */
      --radius: 12px;
    }

    *{box-sizing: border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#0f172a}

    /* Header */
    header.app-header{
      display:flex;align-items:center;gap:12px;padding:12px 16px;background:linear-gradient(90deg,#ffffff 0%, #eef2ff 100%);box-shadow:0 2px 8px rgba(15,23,42,0.04);position:sticky;top:0;z-index:1000
    }
    .brand{
      display:flex;align-items:center;gap:10px
    }
    .logo{
      width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px
    }
    .title{font-weight:700;font-size:16px}
    .subtitle{font-size:12px;color:var(--muted)}

    /* Layout */
    #map{height:56vh;width:100%;border-bottom:1px solid rgba(15,23,42,0.04)}

    .controls{
      max-width:980px;margin:14px auto;padding:0 14px
    }

    .form-card{
      background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 8px 20px rgba(2,6,23,0.06);display:grid;grid-template-columns:repeat(2,1fr);gap:12px;align-items:end
    }
    .form-row{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    select,input{height:40px;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:15px}
    input::placeholder{color:#9aa4b2}

    .full{grid-column:1/-1}

    .submit-btn{background:var(--accent-2);border:none;color:white;padding:10px;border-radius:10px;font-weight:600;cursor:pointer;height:44px}
    .submit-btn:active{transform:translateY(1px)}

    /* Legend */
    .legend{display:flex;gap:8px;align-items:center;margin-top:10px}
    .legend .item{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .dot{width:12px;height:12px;border-radius:50%}
    .dot.red{background:#ef4444}
    .dot.green{background:#10b981}

    /* popup button style override */
    .leaflet-popup-content-wrapper{border-radius:10px}
    .popup-content{min-width:220px}
    .popup-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .popup-title{font-weight:700;font-size:15px;margin:0}
    .popup-sub{font-size:13px;color:var(--muted);margin:0}

    .popup-btn{display:block;width:100%;padding:8px;border-radius:8px;border:none;font-weight:600;cursor:pointer;margin-top:8px}
    .btn-approve{background:#f59e0b;color:white}
    .btn-complete{background:#10b981;color:white}
    .btn-danger{background:#ef4444;color:white}

    /* toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:rgba(15,23,42,0.9);color:white;padding:10px 14px;border-radius:8px;z-index:2000;display:none}

    /* responsive */
    @media(max-width:720px){
      .form-card{grid-template-columns:1fr}
      .title{font-size:15px}
      .logo{width:36px;height:36px}
      #map{height:52vh}
    }
  </style>

</head>
<body>

  <div id="map"></div>

  <div class="controls">
    <div class="form-card" role="region" aria-label="募集フォーム">
      <div class="form-row">
        <label for="old">年齢</label>
        <select id="old">
          <option value="">選択してください</option>
          <option value="60代">60代</option>
          <option value="70代">70代</option>
          <option value="80代">80代</option>
          <option value="90代">90代</option>
          <option value="100代以降">100代以降</option>
        </select>
      </div>

      <div class="form-row">
        <label for="gender">性別</label>
        <select id="gender">
          <option value="">選択してください</option>
          <option value="男性">男性</option>
          <option value="女性">女性</option>
          <option value="その他">その他</option>
        </select>
      </div>

      <div class="form-row full">
        <label for="title">タイトル</label>
        <select id="title">
          <option value="">選択してください</option>
          <option value="荷物運び">荷物運び</option>
          <option value="道案内">道案内</option>
          <option value="家の手伝い">家の手伝い</option>
          <option value="ごみ捨て">ごみ捨て</option>
          <option value="その他">その他</option>
        </select>
      </div>

      <div class="form-row full">
        <label for="naiyo">募集内容（任意）</label>
        <input id="naiyo" type="text" placeholder="例：スーパーまで荷物を運んでほしい">
      </div>

      <div class="form-row full">
        <button class="submit-btn" onclick="buttonClick()">募集する</button>
      </div>

    </div>

    <div class="legend" aria-hidden="true">
      <div class="item"><span class="dot red"></span>未承認</div>
      <div class="item"><span class="dot green"></span>承認済み</div>
      <div class="item" style="margin-left:8px;color:var(--muted);font-size:13px">※青点があなたの現在地（半径3km内のみ表示）</div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Leaflet JS (no defer) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // map & layers
    let map;
    const markersLayer = L.layerGroup();

    // icons
    const redIcon = new L.Icon({
      iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
      iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28]
    });
    const greenIcon = new L.Icon({
      iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
      iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28]
    });
    const blueIcon = new L.Icon({
      iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
      iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28]
    });

    // user location tracking
    let userLatLng = null;
    let userMarker = null;
    let userCircle = null;
    const RADIUS_METERS = 3000; // 3km

    function toast(msg, timeout=2400){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.display = 'block';
      clearTimeout(el._t);
      el._t = setTimeout(()=> el.style.display = 'none', timeout);
    }

    function initMap(){
      map = L.map('map', {zoomControl:true, attributionControl:false}).setView([35.7,139.49], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
      markersLayer.addTo(map);

      // try to center on user and set userLatLng; only after success we load markers (so filtering works)
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          setUserLocation(lat, lng);
          map.setView([lat, lng], 15);
          loadMarkers(); // load after we have user location so filtering applies
        }, (err)=>{
          console.warn('geoloc err', err);
          toast('位置情報を許可してください（半径3km以内の募集のみ表示されます）', 4000);
          // do not call loadMarkers() — 明示的に位置情報が必要なので表示しない
        }, {enableHighAccuracy:true, timeout:8000});
      } else {
        toast('このブラウザは位置情報に対応していません', 3000);
      }

      // refresh markers when map moves (throttle simple)
      let t;
      map.on('moveend', ()=>{ clearTimeout(t); t=setTimeout(loadMarkers,400); });
    }

    function setUserLocation(lat, lng){
      userLatLng = L.latLng(lat, lng);

      // add/update marker
      if(userMarker){
        userMarker.setLatLng(userLatLng);
      } else {
        userMarker = L.marker(userLatLng, {icon: blueIcon, zIndexOffset:1000}).addTo(map).bindPopup('現在地');
      }

      // add/update circle
      if(userCircle){
        userCircle.setLatLng(userLatLng);
      } else {
        userCircle = L.circle(userLatLng, {
          radius: RADIUS_METERS,
          color: 'rgba(37,99,235,0.8)',
          weight: 1,
          fillColor: 'rgba(37,99,235,0.08)',
          fillOpacity: 0.08
        }).addTo(map);
      }
    }

    function clearMarkers(){ markersLayer.clearLayers(); }

    function loadMarkers(){
      // require userLatLng to filter; if not present do nothing
      if(!userLatLng){
        // safety: do not show anything until location is granted
        return;
      }

      fetch('/list').then(r=>r.json()).then(data=>{
        clearMarkers();
        let shown = 0;
        data.forEach((item, index)=>{
          // if coordinates missing, skip
          if(typeof item.lat !== 'number' || typeof item.lng !== 'number') return;

          const itemLatLng = L.latLng(item.lat, item.lng);
          const dist = userLatLng.distanceTo(itemLatLng); // meters

          if(dist > RADIUS_METERS) return; // filter out if outside 3km

          const icon = item.approved ? greenIcon : redIcon;
          const marker = L.marker(itemLatLng, {icon});

          // popup content (styled card)
          const naiyoEsc = item.naiyo ? escapeHtml(item.naiyo) : '';
          const pop = document.createElement('div');
          pop.className = 'popup-content';

          const t = document.createElement('p'); t.className='popup-title'; t.textContent = item.title || '（タイトルなし）';
          const s = document.createElement('p'); s.className='popup-sub'; s.textContent = `${item.age || '年齢不明'} ・ ${item.gender || '性別不明'}`;
          const d = document.createElement('p'); d.style.marginTop='8px'; d.style.marginBottom='0'; d.textContent = naiyoEsc || '(詳細なし)';
          const distp = document.createElement('p'); distp.className='popup-sub'; distp.style.marginTop='6px';
          distp.textContent = `現在地から ${(dist/1000).toFixed(2)} km`;

          pop.appendChild(t);
          pop.appendChild(s);
          pop.appendChild(d);
          pop.appendChild(distp);

          const btnWrap = document.createElement('div'); btnWrap.style.marginTop='8px';

          if(!item.approved){
            const btn = document.createElement('button'); btn.className='popup-btn btn-approve'; btn.textContent='承認する';
            btn.onclick = ()=>{ approve(index); };
            btnWrap.appendChild(btn);
          } else {
            const btn = document.createElement('button'); btn.className='popup-btn btn-complete'; btn.textContent='完了';
            btn.onclick = ()=>{ if(confirm('この募集を完了して削除しますか？')) complete(index); };
            btnWrap.appendChild(btn);

            const del = document.createElement('button'); del.className='popup-btn btn-danger'; del.textContent='通報/削除'; del.style.marginTop='6px';
            del.onclick = ()=>{ if(confirm('本当に削除しますか？')) complete(index); };
            // optional: only admin can see 'del' in future
            // btnWrap.appendChild(del);
          }

          pop.appendChild(btnWrap);

          marker.bindPopup(pop);
          marker.addTo(markersLayer);
          shown++;
        });

        toast(`半径3km内の募集を ${shown} 件表示しました`, 1800);
      }).catch(err=>{
        console.error('loadMarkers error', err);
        toast('募集の取得に失敗しました');
      });
    }

    function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function buttonClick(){
      // gather
      const old = document.getElementById('old').value;
      const gender = document.getElementById('gender').value;
      const title = document.getElementById('title').value;
      const naiyo = document.getElementById('naiyo').value;

      // simple validation
      if(!title){ toast('タイトルを選んでください'); return; }

      // get geolocation and post
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const payload = { lat: pos.coords.latitude, lng: pos.coords.longitude, age: old, gender: gender, title: title, naiyo: naiyo };
          fetch('/add', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)})
            .then(r=>r.json()).then(()=>{ toast('募集を投稿しました'); loadMarkers(); })
            .catch(()=>toast('投稿に失敗しました'));
        }, ()=>{
          toast('位置情報を取得できませんでした（ブラウザの設定を確認）');
        }, {timeout:5000});
      } else {
        toast('このブラウザは位置情報に対応していません');
      }
    }

    function approve(index){
      fetch('/approve', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({index})})
        .then(r=>r.json()).then(()=>{ toast('承認しました'); loadMarkers(); })
        .catch(()=>toast('承認に失敗しました'));
    }

    function complete(index){
      fetch('/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({index})})
        .then(r=>r.json()).then(()=>{ toast('募集を完了しました'); loadMarkers(); })
        .catch(()=>toast('削除に失敗しました'));
    }

    // init on load
    window.addEventListener('load', initMap);
  </script>
</body>
</html>
